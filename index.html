<!DOCTYPE html>
<html>
<head>
    <title>Space Builder: Sunlight Edition</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; background: #000; color: white; touch-action: none; }
        #build-screen { display: flex; flex-direction: column; height: 100vh; background: #050505; position: relative; z-index: 100; }
        #blueprint-area { flex-grow: 1; position: relative; background: radial-gradient(#1a1a1a 1px, transparent 1px) 0 0/25px 25px; border-bottom: 2px solid #0f0; display: flex; flex-direction: column-reverse; align-items: center; }
        #menu-container { height: 60%; display: flex; flex-direction: column; background: #111; border-top: 2px solid #0f0; }
        
        .top-launch-btn { background: #00ff00; color: #000; padding: 15px; font-weight: bold; cursor: pointer; border: none; font-size: 18px; text-transform: uppercase; }
        .scroll-nav { background: #222; color: #0f0; text-align: center; padding: 10px; font-weight: bold; cursor: pointer; border: none; font-size: 24px; }
        
        #parts-grid { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; align-content: center; }
        .part-btn { background: #16213e; color: white; border: 2px solid #00ff00; font-size: 12px; font-weight: bold; border-radius: 8px; cursor: pointer; min-height: 70px; display: flex; align-items: center; justify-content: center; text-align: center; }

        #flight-ui { position: absolute; top: 20px; width: 100%; display: none; flex-direction: column; align-items: center; pointer-events: none; z-index: 300; }
        .meter { background: rgba(0,0,0,0.8); padding: 5px 15px; border: 2px solid #0f0; border-radius: 5px; font-size: 18px; color: #0f0; font-weight: bold; margin-bottom: 5px; width: 220px; text-align: center; }
        #msg { color: #55f; font-weight: bold; height: 20px; text-shadow: 0 0 5px #000; }
        
        /* Updated Button: Visible and clickable */
        #deploy-btn { background: #d00; color: white; border: 3px solid white; padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 10px; pointer-events: auto; cursor: pointer; display: none; margin-top: 10px; box-shadow: 0 0 10px #000; }

        #flight-controls { position: absolute; bottom: 40px; width: 100%; display: none; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 200; }
        .move-btn { background: rgba(0,255,0,0.3); color: #0f0; border: 2px solid #0f0; width: 80px; height: 80px; border-radius: 50%; font-size: 40px; cursor: pointer; outline: none; }
        .thrust-switch { appearance: none; width: 60px; height: 100px; background: #444; border: 4px solid #fff; border-radius: 10px; position: relative; cursor: pointer; }
        .thrust-switch:checked { background: #ff4500; }
        .thrust-switch::after { content: ''; position: absolute; top: 5px; left: 5px; width: 42px; height: 40px; background: #eee; border-radius: 5px; transition: 0.2s; }
        .thrust-switch:checked::after { transform: translateY(42px); }

        .placed-part { width: 120px; margin: 0 auto; color: white; font-weight: bold; font-size: 9px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.3); background: #333; }
    </style>
</head>
<body>

    <div id="build-screen">
        <div style="padding:15px; color:#0f0; font-size:22px; font-weight:bold;">BUDGET: $<span id="cash">10000</span></div>
        <div id="blueprint-area"><div id="rocket-container" style="display: flex; flex-direction: column-reverse; align-items: center; padding-bottom: 20px;"></div></div>
        
        <div id="menu-container">
            <button class="top-launch-btn" onclick="goToLaunchpad()">ðŸš€ GO TO LAUNCHPAD</button>
            <button class="scroll-nav" onclick="scrollParts(-1)">â–² SCROLL UP</button>
            <div id="parts-grid"></div>
            <button class="scroll-nav" onclick="scrollParts(1)">â–¼ SCROLL DOWN</button>
            <button style="background:#600; color:white; padding:10px; border:none; font-weight:bold;" onclick="undo()">âš  DELETE LAST PART</button>
        </div>
    </div>

    <div id="flight-ui">
        <div class="meter" id="alt-meter">ALTITUDE: 0m</div>
        <div class="meter" id="vel-meter">VELOCITY: 0m/s</div>
        <div id="msg"></div>
        <button id="deploy-btn" onclick="deployParachute()">DEPLOY PARACHUTE</button>
    </div>

    <div id="flight-controls">
        <button class="move-btn" onmousedown="isLeft=true" onmouseup="isLeft=false" ontouchstart="isLeft=true" ontouchend="isLeft=false">â—€</button>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <input type="checkbox" id="t-switch" class="thrust-switch" onchange="toggleThrust(this)">
            <span style="font-weight:bold;">THRUST</span>
        </div>
        <button class="move-btn" onmousedown="isRight=true" onmouseup="isRight=false" ontouchstart="isRight=true" ontouchend="isRight=false">â–¶</button>
    </div>

    <a-scene id="game-scene" style="display:none" renderer="colorManagement: true; physicallyCorrectLights: true;">
        <a-entity light="type: ambient; intensity: 0.3; color: #444;"></a-entity>
        <a-entity light="type: directional; intensity: 2.5; castShadow: true; color: #FFFACD;" position="-100 300 -100"></a-entity>

        <a-sky id="sky" color="#87CEEB"></a-sky>
        <a-entity id="stars" visible="false"><a-star-system></a-star-system></a-entity>
        
        <a-sphere position="-100 300 -100" radius="30" color="#FDB813" material="shader: flat; emissive: #FDB813; emissiveIntensity: 1"></a-sphere>
        
        <a-entity id="moon-orbit-rig" rotation="0 0 0">
            <a-sphere position="0 600 -200" radius="20" color="#CCCCCC" material="roughness: 1"></a-sphere>
        </a-entity>

        <a-circle position="0 0 0" rotation="-90 0 0" radius="800" color="#228B22"></a-circle>
        
        <a-cylinder position="0 0.2 0" radius="6" height="0.4" color="#555555"></a-cylinder>

        <a-entity id="repair-station" position="20 0 0">
            <a-box width="8" height="10" depth="6" color="#999999" position="0 5 0"></a-box>
            <a-box width="3" height="4" depth="0.2" color="#444444" position="0 2 3.1"></a-box>
            <a-box width="0.1" height="4" depth="0.3" color="#000" position="0 2 3.1"></a-box>
            <a-box width="7" height="2" depth="0.5" color="#eeeeee" position="0 8 3"></a-box>
            <a-text value="REPAIR" align="center" position="0 8 3.3" color="#cc0000" scale="3 3 3"></a-text>
        </a-entity>

        <a-entity id="rocket-group" position="0 0.4 0">
            <a-entity id="rocket-body" rotation="0 0 0">
                <a-entity id="visual-stack"></a-entity>
                <a-entity id="fire" position="0 -1.5 0" visible="false">
                    <a-cone color="#ff4500" radius-bottom="0.8" radius-top="0.1" height="2" material="emissive: #ff4500; emissiveIntensity: 2"></a-cone>
                </a-entity>
            </a-entity>
        </a-entity>
        
        <a-camera id="cam" position="0 5 30" look-controls="enabled: false"></a-camera>
    </a-scene>

    <script>
        const PART_PAGES = [
            [
                {name: 'Capsule', cost: 200, type: 'capsule', color: '#DDDDDD', h: 2},
                {name: 'Parachute', cost: 150, type: 'parachute', color: '#ff0000', h: 0.8},
                {name: 'Fuel Tank', cost: 300, type: 'tank', color: '#ff9900', h: 3}
            ],
            [
                {name: 'Booster', cost: 400, type: 'booster', color: '#333333', h: 2.5},
                {name: 'Heat Shield', cost: 200, type: 'shield', color: '#ff6600', h: 0.3},
                {name: 'Decoupler', cost: 100, type: 'cylinder', color: '#222222', h: 0.4}
            ]
        ];

        let stack = [], graveyard = [], cash = 10000, currentPage = 0;
        let isThrusting = false, isLeft = false, isRight = false, paraDeployed = false, hasParachute = false;
        let vY = 0, vX = 0, posX = 0, posY = 0.4, rotation = 0;
        let moonAngle = 0;

        function renderParts() {
            const grid = document.getElementById('parts-grid');
            grid.innerHTML = "";
            PART_PAGES[currentPage].forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'part-btn';
                btn.innerHTML = p.name.toUpperCase() + "<br>($" + p.cost + ")";
                btn.onclick = () => addPart(p);
                grid.appendChild(btn);
            });
        }

        function scrollParts(dir) { currentPage = (currentPage + dir + PART_PAGES.length) % PART_PAGES.length; renderParts(); }

        function addPart(p) {
            if (cash < p.cost) return;
            cash -= p.cost;
            const el = document.createElement('div');
            el.className = 'placed-part';
            el.style.height = (p.h * 20) + 'px';
            el.innerText = p.name.toUpperCase();
            document.getElementById('rocket-container').appendChild(el);
            document.getElementById('cash').innerText = cash;
            stack.push({...p, id: 'p' + Math.random().toString(36).substr(2, 9)});
            if(p.type === 'parachute') hasParachute = true;
        }

        function undo() {
            if (stack.length === 0) return;
            const last = stack.pop();
            document.getElementById('rocket-container').lastChild.remove();
            cash += last.cost;
            document.getElementById('cash').innerText = cash;
            // Check if we removed the parachute
            hasParachute = stack.some(part => part.type === 'parachute');
        }

        function buildRocketVisuals() {
            const v = document.getElementById('visual-stack');
            v.innerHTML = "";
            let currentH = 0;
            stack.forEach(p => {
                const container = document.createElement('a-entity');
                container.setAttribute('id', p.id);
                container.setAttribute('position', '0 ' + (currentH + (p.h/2)) + ' 0');

                if (p.type === 'capsule') {
                    const body = document.createElement('a-cone');
                    body.setAttribute('height', p.h);
                    body.setAttribute('radius-bottom', 1);
                    body.setAttribute('radius-top', 0);
                    body.setAttribute('color', p.color);
                    container.appendChild(body);
                    const door = document.createElement('a-box');
                    door.setAttribute('color', '#333');
                    door.setAttribute('width', 0.4); door.setAttribute('height', 0.8); door.setAttribute('depth', 0.1);
                    door.setAttribute('position', '0 -0.2 0.8'); door.setAttribute('rotation', '-15 0 0');
                    container.appendChild(door);
                } else if (p.type === 'parachute') {
                    const pack = document.createElement('a-cone');
                    pack.setAttribute('height', p.h);
                    pack.setAttribute('radius-bottom', 0.5); pack.setAttribute('radius-top', 0.1);
                    pack.setAttribute('color', p.color);
                    container.appendChild(pack);
                } else if (p.type === 'booster') {
                    const nozzle = document.createElement('a-cone');
                    nozzle.setAttribute('height', p.h);
                    nozzle.setAttribute('radius-bottom', 1.2); nozzle.setAttribute('radius-top', 0.8);
                    nozzle.setAttribute('color', p.color);
                    container.appendChild(nozzle);
                } else if (p.type === 'shield') {
                    const disc = document.createElement('a-cylinder');
                    disc.setAttribute('height', p.h); disc.setAttribute('radius', 1.1); disc.setAttribute('color', p.color);
                    container.appendChild(disc);
                } else if (p.type === 'tank') {
                    const tank = document.createElement('a-cylinder');
                    tank.setAttribute('height', p.h); tank.setAttribute('radius', 1); tank.setAttribute('color', p.color);
                    container.appendChild(tank);
                } else {
                    const gen = document.createElement('a-cylinder');
                    gen.setAttribute('height', p.h); gen.setAttribute('radius', 1); gen.setAttribute('color', p.color);
                    container.appendChild(gen);
                }
                currentH += p.h;
                v.appendChild(container);
            });
        }

        function goToLaunchpad() {
            if (stack.length === 0) return;
            document.getElementById('build-screen').style.display = 'none';
            document.getElementById('game-scene').style.display = 'block';
            document.getElementById('flight-controls').style.display = 'flex';
            document.getElementById('flight-ui').style.display = 'flex';
            buildRocketVisuals();
            physics();
        }

        function toggleThrust(el) {
            isThrusting = el.checked;
            document.getElementById('fire').setAttribute('visible', isThrusting);
            if(isThrusting && paraDeployed) deployParachute();
        }

        function deployParachute() {
            if (!hasParachute) return;
            paraDeployed = !paraDeployed;
            const chuteData = stack.find(p => p.type === 'parachute');
            if (!chuteData) return;
            const chuteContainer = document.getElementById(chuteData.id);
            if (!chuteContainer) return;

            chuteContainer.innerHTML = ''; 

            if (paraDeployed) {
                // Open Chute Visuals
                const canopy = document.createElement('a-sphere');
                canopy.setAttribute('phi-length', 180); canopy.setAttribute('theta-length', 90);
                canopy.setAttribute('radius', 3); canopy.setAttribute('color', '#ff0000');
                canopy.setAttribute('rotation', '90 0 0'); canopy.setAttribute('side', 'double');
                canopy.setAttribute('position', '0 1 0');
                chuteContainer.appendChild(canopy);
                const line = document.createElement('a-cylinder');
                line.setAttribute('height', 1); line.setAttribute('radius', 0.05); line.setAttribute('position', '0 0.5 0');
                chuteContainer.appendChild(line);
                document.getElementById('deploy-btn').innerText = "CUT PARACHUTE";
            } else {
                // Closed Pack Visuals
                const pack = document.createElement('a-cone');
                pack.setAttribute('height', 0.8); pack.setAttribute('radius-bottom', 0.5); pack.setAttribute('radius-top', 0.1);
                pack.setAttribute('color', '#ff0000');
                chuteContainer.appendChild(pack);
                document.getElementById('deploy-btn').innerText = "DEPLOY PARACHUTE";
            }
        }

        function physics() {
            // Rocket Physics
            if (isLeft) rotation += 1.5;
            if (isRight) rotation -= 1.5;
            document.getElementById('rocket-body').setAttribute('rotation', '0 0 ' + rotation);

            let rad = rotation * (Math.PI / 180);
            if (isThrusting) {
                vX += Math.sin(-rad) * 0.007;
                vY += Math.cos(rad) * 0.007;
            } else {
                vY -= 0.0025; // Gravity
            }

            // Stronger Air Resistance when Chute is Open
            if (paraDeployed && vY < 0) vY *= 0.80; // Slows down fall significantly
            vX *= 0.99;
            posX += vX;
            posY += vY;

            let vel = Math.sqrt(vX*vX + vY*vY) * 1000;

            // Ground Collision
            if (posY <= 0.4) {
                if (vel > 80 && stack.length > 0) {
                    const destroyed = stack.shift();
                    graveyard.push(destroyed);
                    if (destroyed.name === "Capsule") { alert("GAME OVER: CAPSULE DESTROYED!"); location.reload(); }
                    buildRocketVisuals();
                    posY = 1.0; vY = Math.abs(vY) * 0.2; // Bounce slightly
                } else {
                    posY = 0.4; vY = 0; vX = 0;
                }
            }

            // Repair Logic
            const distToRepair = Math.abs(posX - 20);
            if (distToRepair < 5 && posY < 1.0 && graveyard.length > 0) {
                if (cash >= 500) {
                    cash -= 500;
                    stack.unshift(graveyard.pop());
                    buildRocketVisuals();
                    document.getElementById('msg').innerText = "PART REPAIRED! -$500";
                    setTimeout(() => document.getElementById('msg').innerText = "", 2000);
                }
            }

            // Camera & Scene Updates
            document.getElementById('rocket-group').setAttribute('position', posX + ' ' + posY + ' 0');
            document.getElementById('cam').setAttribute('position', posX + ' ' + (posY + 5) + ' 30');
            document.getElementById('alt-meter').innerText = "ALTITUDE: " + Math.round(posY * 100) + "m";
            const vEl = document.getElementById('vel-meter');
            vEl.innerText = "VELOCITY: " + Math.round(vel) + "m/s";
            vEl.style.color = vel > 80 ? "#ff0000" : "#00ff00";

            // === PARACHUTE BUTTON LOGIC FIX ===
            // Show button if we have a parachute AND we are off the ground (Altitude > 1m)
            if (hasParachute && posY > 1) {
                document.getElementById('deploy-btn').style.display = 'block';
            } else {
                document.getElementById('deploy-btn').style.display = 'none';
            }

            // Sky, Stars, and Moon Orbit
            let sV = Math.max(0, 135 - (posY / 3)); 
            document.getElementById('sky').setAttribute('color', "rgb(" + Math.round(sV) + "," + Math.round(sV+50) + "," + Math.round(sV+100) + ")");
            if (posY > 150) document.getElementById('stars').setAttribute('visible', 'true');
            
            // Orbit Animation
            moonAngle += 0.05;
            document.getElementById('moon-orbit-rig').setAttribute('rotation', '0 0 ' + moonAngle);

            requestAnimationFrame(physics);
        }

        AFRAME.registerComponent('star-system', {
            init: function () {
                const geom = new THREE.BufferGeometry();
                const verts = [];
                for (let i = 0; i < 2000; i++) verts.push(THREE.MathUtils.randFloatSpread(1000), THREE.MathUtils.randFloatSpread(1000), THREE.MathUtils.randFloatSpread(1000));
                geom.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
                this.el.setObject3D('mesh', new THREE.Points(geom, new THREE.PointsMaterial({color: 0xFFFFFF, size: 0.5})));
            }
        });

        window.onload = renderParts;
    </script>
</body>
</html>
