<!DOCTYPE html>
<html>
<head>
    <title>Space Builder: Map Mode & Orbits</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; background: #000; color: white; touch-action: none; }
        #build-screen { display: flex; flex-direction: column; height: 100vh; background: #050505; position: relative; z-index: 100; }
        #blueprint-area { flex-grow: 1; position: relative; background: radial-gradient(#1a1a1a 1px, transparent 1px) 0 0/25px 25px; border-bottom: 2px solid #0f0; cursor: grab; }
        #menu-container { height: 40%; display: flex; flex-direction: column; background: #111; border-top: 2px solid #0f0; }
        .top-launch-btn { background: #00ff00; color: #000; padding: 12px; font-weight: bold; cursor: pointer; border: none; font-size: 18px; }
        #parts-grid { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; align-content: center; }
        .part-btn { background: #16213e; color: white; border: 2px solid #00ff00; font-size: 11px; font-weight: bold; border-radius: 8px; cursor: pointer; min-height: 40px; }

        /* Flight UI */
        #flight-ui { position: absolute; top: 20px; width: 100%; display: none; flex-direction: column; align-items: center; pointer-events: none; z-index: 300; }
        .meter { background: rgba(0,0,0,0.8); padding: 4px 12px; border: 2px solid #0f0; border-radius: 5px; font-size: 14px; color: #0f0; font-weight: bold; margin-bottom: 4px; width: 240px; text-align: center; }
        .bar-container { width: 240px; height: 10px; background: #333; border: 1px solid #fff; margin-bottom: 5px; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.1s; background: #00ccff; }
        .bar-label { position: absolute; width: 100%; text-align: center; font-size: 9px; font-weight: bold; color: white; top: -1px; }

        /* Map UI */
        #map-toggle { position: absolute; top: 20px; right: 20px; background: #444; color: #0f0; border: 2px solid #0f0; padding: 10px; font-weight: bold; cursor: pointer; z-index: 400; display: none; pointer-events: auto; }
        #map-overlay { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 250; display: none; }
        #map-canvas { width: 100%; height: 100%; }

        #flight-controls { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 400; }
        .move-btn { background: rgba(0,255,0,0.3); color: #0f0; border: 2px solid #0f0; width: 70px; height: 70px; border-radius: 50%; font-size: 30px; pointer-events: auto; }
        .thrust-switch { appearance: none; width: 55px; height: 90px; background: #444; border: 3px solid #fff; border-radius: 10px; position: relative; pointer-events: auto; }
        .thrust-switch:checked { background: #ff4500; }
        .thrust-switch::after { content: ''; position: absolute; top: 5px; left: 5px; width: 39px; height: 39px; background: #eee; border-radius: 5px; transition: 0.2s; }
        .thrust-switch:checked::after { transform: translateY(40px); }
        
        .flight-btn { background: #d00; color: white; border: 2px solid white; padding: 8px; font-weight: bold; border-radius: 5px; pointer-events: auto; display: none; margin: 3px; }
    </style>
</head>
<body onmousedown="startDrag(event)" onmousemove="doDrag(event)" onmouseup="stopDrag()" ontouchstart="startDrag(event)" ontouchmove="doDrag(event)" ontouchend="stopDrag()">

    <div id="build-screen">
        <div style="padding:10px; color:#0f0; font-size:18px;">BUDGET: $<span id="cash">10000</span></div>
        <div id="blueprint-area">
            <a-scene embedded style="height: 100%; width: 100%; pointer-events: none;" vr-mode-ui="enabled: false">
                <a-entity light="type: ambient; intensity: 0.8;"></a-entity>
                <a-entity id="build-rig"><a-entity id="build-stack" position="0 -2 0"></a-entity></a-entity>
                <a-camera position="0 0 10" look-controls="enabled: false"></a-camera>
            </a-scene>
        </div>
        <div id="menu-container">
            <button class="top-launch-btn" onclick="goToLaunchpad()">ðŸš€ IGNITION</button>
            <div id="parts-grid"></div>
            <button style="background:#400; color:white; border:none; padding:8px;" onclick="undo()">UNDO</button>
        </div>
    </div>

    <button id="map-toggle" onclick="toggleMap()">VIEW MAP</button>
    
    <div id="map-overlay">
        <canvas id="map-canvas"></canvas>
    </div>

    <div id="flight-ui">
        <div class="meter" id="alt-meter">ALT: 0m</div>
        <div class="meter" id="vel-meter">VEL: 0m/s</div>
        <div class="bar-container"><div id="fuel-bar" class="bar-fill"></div><div class="bar-label">FUEL: <span id="fuel-txt">0</span> gal</div></div>
        <div id="msg" style="color:yellow; font-weight:bold;"></div>
        <button id="decouple-btn" class="flight-btn" onclick="decouple()">DECOUPLE</button>
        <button id="deploy-btn" class="flight-btn" onclick="deployParachute()">PARACHUTE</button>
    </div>

    <div id="flight-controls">
        <button class="move-btn" onmousedown="isLeft=true" onmouseup="isLeft=false" ontouchstart="isLeft=true" ontouchend="isLeft=false">â—€</button>
        <input type="checkbox" id="t-switch" class="thrust-switch" onchange="toggleThrust(this)">
        <button class="move-btn" onmousedown="isRight=true" onmouseup="isRight=false" ontouchstart="isRight=true" ontouchend="isRight=false">â–¶</button>
    </div>

    <a-scene id="game-scene" style="display:none">
        <a-sky id="sky" color="#87CEEB"></a-sky>
        <a-entity id="earth-group">
            <a-circle position="0 -1 0" rotation="-90 0 0" radius="3000" color="#1E90FF"></a-circle>
            <a-circle position="0 0.1 0" rotation="-90 0 0" radius="50" color="#228B22"></a-circle>
        </a-entity>
        <a-entity id="moon-group" position="4000 6000 0">
            <a-sphere radius="150" color="#AAA"></a-sphere>
        </a-entity>
        <a-entity id="cam-pivot">
            <a-entity id="rocket-group">
                <a-entity id="rocket-body">
                    <a-entity id="flight-stack"></a-entity>
                    <a-entity id="fire" position="0 -1.5 0" visible="false">
                        <a-cone color="#ff4500" radius-bottom="0.8" radius-top="0.1" height="2"></a-cone>
                    </a-entity>
                </a-entity>
            </a-entity>
            <a-camera id="cam" position="0 5 25" look-controls="enabled: false"></a-camera>
        </a-entity>
    </a-scene>

    <script>
        const PARTS = [
            {name: 'Capsule', cost: 200, type: 'capsule', color: '#EEE', h: 2},
            {name: 'Fuel Tank', cost: 300, type: 'tank', color: '#f90', h: 3},
            {name: 'Booster', cost: 400, type: 'booster', color: '#333', h: 2},
            {name: 'Parachute', cost: 150, type: 'parachute', color: '#f00', h: 0.8},
            {name: 'Decoupler', cost: 100, type: 'decoupler', color: '#222', h: 0.4}
        ];

        let stack = [], cash = 10000, isFlying = false, isMap = false;
        let isDragging = false, lastX = 0, lastY = 0, orbitY = 0, orbitX = 0;
        let isThrusting = false, isLeft = false, isRight = false, paraDeployed = false;
        let vY = 0, vX = 0, posX = 0, posY = 0.5, rotation = 0;
        let currentFuel = 0, maxFuel = 0, hasEngine = false, hasChute = false;

        // Map Canvas setup
        const canvas = document.getElementById('map-canvas');
        const ctx = canvas.getContext('2d');

        function startDrag(e) { isDragging = true; lastX = e.pageX || e.touches[0].pageX; lastY = e.pageY || e.touches[0].pageY; }
        function stopDrag() { isDragging = false; }
        function doDrag(e) {
            if (!isDragging || isMap) return;
            let x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            let y = e.pageY || (e.touches ? e.touches[0].pageY : 0);
            orbitY += (x - lastX) * 0.5;
            orbitX = Math.max(-40, Math.min(40, orbitX - (y - lastY) * 0.5));
            if (!isFlying) document.getElementById('build-rig').setAttribute('rotation', `0 ${orbitY} 0`);
            else document.getElementById('cam-pivot').setAttribute('rotation', `${orbitX} ${orbitY} 0`);
            lastX = x; lastY = y;
        }

        function toggleMap() {
            isMap = !isMap;
            document.getElementById('map-overlay').style.display = isMap ? 'block' : 'none';
            document.getElementById('game-scene').style.display = isMap ? 'none' : 'block';
            document.getElementById('map-toggle').innerText = isMap ? "CLOSE MAP" : "VIEW MAP";
        }

        function renderParts() {
            const grid = document.getElementById('parts-grid');
            PARTS.forEach(p => {
                const btn = document.createElement('button'); btn.className = 'part-btn';
                btn.innerHTML = `${p.name}<br>$${p.cost}`;
                btn.onclick = () => { if(cash>=p.cost){cash-=p.cost; stack.push({...p, id:'p'+Math.random()}); updateStacks();} };
                grid.appendChild(btn);
            });
        }

        function updateStacks() {
            document.getElementById('cash').innerText = cash;
            buildVisuals('build-stack');
            hasChute = stack.some(p => p.type === 'parachute');
            hasEngine = stack.some(p => p.type === 'booster');
            maxFuel = stack.filter(p => p.type === 'tank').length * 50;
            currentFuel = maxFuel;
        }

        function buildVisuals(targetId) {
            const v = document.getElementById(targetId); v.innerHTML = "";
            let currentH = 0;
            stack.forEach(p => {
                const container = document.createElement('a-entity');
                container.setAttribute('position', `0 ${currentH + (p.h/2)} 0`);
                container.setAttribute('id', targetId === 'flight-stack' ? p.id : '');
                let shape = (p.type==='capsule'||p.type==='parachute'||p.type==='booster') ? 'a-cone' : 'a-cylinder';
                const mesh = document.createElement(shape);
                mesh.setAttribute('height', p.h); mesh.setAttribute('color', p.color);
                mesh.setAttribute('radius-bottom', p.type==='booster'?1.2:1);
                mesh.setAttribute('radius-top', (p.type==='capsule'||p.type==='parachute')?0:1);
                container.appendChild(mesh);
                currentH += p.h; v.appendChild(container);
            });
        }

        function goToLaunchpad() {
            if (stack.length === 0) return;
            isFlying = true;
            document.getElementById('build-screen').style.display = 'none';
            document.getElementById('game-scene').style.display = 'block';
            document.getElementById('flight-controls').style.display = 'flex';
            document.getElementById('flight-ui').style.display = 'flex';
            document.getElementById('map-toggle').style.display = 'block';
            buildVisuals('flight-stack'); physics();
        }

        function toggleThrust(el) { if (el.checked && (currentFuel <= 0 || !hasEngine)) { el.checked = false; return; } isThrusting = el.checked; }
        
        function decouple() {
            const idx = stack.findIndex(p => p.type === 'decoupler');
            if (idx !== -1) { stack.splice(0, idx + 1); buildVisuals('flight-stack'); updateStacks(); currentFuel = Math.min(currentFuel, maxFuel); }
        }

        function deployParachute() { if (!hasChute) return; paraDeployed = !paraDeployed; const p = stack.find(x => x.type === 'parachute'); const el = document.getElementById(p.id); if(el) el.setAttribute('scale', paraDeployed ? '5 5 5' : '1 1 1'); }

        function drawMap() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let scale = 0.05;
            let center = { x: canvas.width/2 - posX*scale, y: canvas.height/2 + posY*scale };

            // Earth
            ctx.fillStyle = "#1E90FF";
            ctx.beginPath(); ctx.arc(center.x, center.y, 3000*scale, 0, Math.PI*2); ctx.fill();
            
            // Moon
            ctx.fillStyle = "#AAA";
            ctx.beginPath(); ctx.arc(center.x + 4000*scale, center.y - 6000*scale, 150*scale, 0, Math.PI*2); ctx.fill();

            // Orbit Prediction
            ctx.strokeStyle = "rgba(0, 200, 255, 0.5)";
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            let tx = posX, ty = posY, tvx = vX, tvy = vY;
            ctx.moveTo(canvas.width/2, canvas.height/2);
            for(let i=0; i<300; i++) {
                tvy -= 0.0025;
                tx += tvx; ty += tvy;
                ctx.lineTo(canvas.width/2 + (tx-posX)*scale, canvas.height/2 - (ty-posY)*scale);
                if(ty <= 0) break;
            }
            ctx.stroke();
            ctx.setLineDash([]);

            // Rocket
            ctx.fillStyle = "#FFF";
            ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 5, 0, Math.PI*2); ctx.fill();
        }

        function physics() {
            if (isLeft) rotation += 2; if (isRight) rotation -= 2;
            document.getElementById('rocket-body').setAttribute('rotation', `0 0 ${rotation}`);
            let rad = rotation * (Math.PI / 180);
            
            if (isThrusting && currentFuel > 0 && hasEngine) {
                currentFuel -= 0.15;
                vX += Math.sin(-rad) * 0.01; vY += Math.cos(rad) * 0.01;
                document.getElementById('fire').setAttribute('visible', true);
            } else {
                document.getElementById('fire').setAttribute('visible', false);
            }

            // Gravity & Friction
            vY -= 0.0025;
            if (posY < 500) { vX *= 0.99; if (paraDeployed && vY < 0) vY *= 0.85; }
            
            posX += vX; posY += vY;

            // Earth Collision
            if (posY <= 0.5) {
                let vel = Math.sqrt(vX*vX + vY*vY) * 1000;
                if (vel > 80 && stack.length > 0) {
                    stack.shift(); updateStacks(); buildVisuals('flight-stack');
                    posY = 1; vY = 0.1;
                } else { posY = 0.5; vX = 0; vY = 0; }
            }

            // UI
            document.getElementById('cam-pivot').setAttribute('position', `${posX} ${posY} 0`);
            document.getElementById('fuel-bar').style.width = maxFuel > 0 ? (currentFuel / maxFuel * 100) + "%" : "0%";
            document.getElementById('alt-meter').innerText = `ALTITUDE: ${Math.round(posY*100)}m`;
            document.getElementById('vel-meter').innerText = `VELOCITY: ${Math.round(Math.sqrt(vX*vX+vY*vY)*1000)}m/s`;

            if (isMap) drawMap();
            requestAnimationFrame(physics);
        }
        window.onload = renderParts;
    </script>
</body>
</html>
