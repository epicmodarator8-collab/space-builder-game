<!DOCTYPE html>
<html>
<head>
    <title>Space Builder: Ultimate Fixed</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; background: #000; color: white; touch-action: none; }
        #build-screen { display: flex; flex-direction: column; height: 100vh; background: #050505; position: relative; z-index: 100; }
        
        #blueprint-area { 
            flex-grow: 1; 
            position: relative; 
            background: radial-gradient(#1a1a1a 1px, transparent 1px) 0 0/25px 25px; 
            border-bottom: 2px solid #0f0; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column-reverse; 
        }

        #menu-container { height: 60%; display: flex; flex-direction: column; background: #111; border-top: 2px solid #0f0; }
        
        /* NEW TOP LAUNCH BUTTON */
        .top-launch-btn { 
            background: #00ff00; color: #000; padding: 18px; font-weight: bold; 
            cursor: pointer; border: none; font-size: 20px; text-transform: uppercase;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3); border-bottom: 3px solid #008800;
        }
        .top-launch-btn:active { background: #00cc00; transform: translateY(2px); }

        .scroll-nav { background: #222; color: #0f0; text-align: center; padding: 12px; font-weight: bold; cursor: pointer; border: none; font-size: 16px; text-transform: uppercase; }
        
        #parts-grid { 
            flex-grow: 1; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            padding: 15px; 
            align-content: center;
        }
        
        .part-btn { 
            background: #16213e; color: white; border: 2px solid #00ff00; font-size: 13px; font-weight: bold; border-radius: 8px; cursor: pointer; min-height: 80px;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }

        /* TEXTURES */
        .tex-capsule { background: linear-gradient(to bottom, #ddd, #999) !important; border: 3px solid #0f0 !important; border-radius: 40% 40% 5px 5px !important; }
        .tex-tech { background: #001a1a; border: 2px solid #00ffff !important; box-shadow: inset 0 0 15px #00ffff; background-image: radial-gradient(#00ffff 1px, transparent 1px) !important; background-size: 6px 6px !important; }
        .tex-fuel { background: linear-gradient(90deg, #cc7a00, #ff9900, #cc7a00) !important; border: 2px solid #0f0 !important;}
        .tex-metal { background: linear-gradient(90deg, #333, #777, #333) !important; border: 2px solid #0f0 !important;}
        .tex-heat { background: #222 !important; border: 2px solid #0f0 !important;}
        .tex-fabric { background: repeating-linear-gradient(45deg, #fff, #fff 10px, #d00 10px, #d00 20px) !important; border: 2px solid #0f0 !important;}

        #sticky-bottom { display: flex; flex-direction: column; }
        .undo-btn { background: #600; color: white; padding: 15px; font-weight: bold; cursor: pointer; text-align: center; border:none; text-transform: uppercase;}
        
        #return-btn { position: absolute; bottom: 20px; right: 20px; padding: 15px; background: #222; color: #0f0; border: 2px solid #0f0; font-weight: bold; cursor: pointer; display: none; z-index: 200; }

        #budget-display { padding: 15px; font-weight: bold; color: #00ff00; font-size: 22px; position: absolute; top: 0; left: 0; z-index: 10; pointer-events: none; }
        .placed-part { width: 140px; margin: 0 auto; color: white; font-weight: bold; font-size: 10px; display: flex; align-items: center; justify-content: center; text-align: center; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.3); }
    </style>
</head>
<body>

    <div id="build-screen">
        <div id="budget-display">BUDGET: $<span id="cash">10000</span></div>
        <div id="blueprint-area"><div id="rocket-container" style="display: flex; flex-direction: column-reverse; align-items: center; padding-bottom: 20px;"></div></div>
        
        <div id="menu-container">
            <button class="top-launch-btn" onclick="launch()">ðŸš€ INITIALIZE LAUNCH</button>
            
            <button class="scroll-nav" onclick="scrollParts(-1)">â–² SCROLL UP</button>
            <div id="parts-grid"></div>
            <button class="scroll-nav" onclick="scrollParts(1)">â–¼ SCROLL DOWN</button>
            <div id="sticky-bottom">
                <button class="undo-btn" onclick="undo()">âš  DELETE LAST PART</button>
            </div>
        </div>
    </div>

    <button id="return-btn" onclick="resetBuilder()">RESET BUILDER</button>

    <a-scene id="game-scene" style="display:none">
        <a-sky color="#000"></a-sky>
        <a-entity id="stars"></a-entity>
        <a-entity id="rocket-group">
            <a-entity id="visual-stack"></a-entity>
            <a-entity id="fire" position="0 -1.8 0" visible="false">
                <a-cone color="#ff4500" radius-bottom="0.9" radius-top="0.1" height="3" opacity="0.8"></a-cone>
                <a-cone color="#ffd700" radius-bottom="0.5" radius-top="0.05" height="2" position="0 0.2 0"></a-cone>
            </a-entity>
        </a-entity>
        <a-camera position="0 5 15"></a-camera>
    </a-scene>

    <script>
        const PART_PAGES = [
            [
                {name: 'Capsule', cost: 200, tex: 'tex-capsule'},
                {name: 'Fairing+Rover', cost: 1000, tex: 'tex-tech'},
                {name: 'Antenna Tank', cost: 600, tex: 'tex-tech'},
                {name: 'Fuel Tank', cost: 300, tex: 'tex-fuel'}
            ],
            [
                {name: 'Booster', cost: 400, tex: 'tex-metal'},
                {name: 'Decoupler', cost: 300, tex: 'tex-heat'},
                {name: 'Heat Shield', cost: 500, tex: 'tex-heat'},
                {name: 'Parachute', cost: 400, tex: 'tex-fabric'}
            ]
        ];

        let currentPage = 0;
        let stack = [], cash = 10000;

        function renderParts() {
            const grid = document.getElementById('parts-grid');
            grid.innerHTML = "";
            PART_PAGES[currentPage].forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'part-btn ' + p.tex;
                btn.innerHTML = `${p.name.toUpperCase()}<br>($${p.cost})`;
                btn.onclick = () => addPart(p.name, p.cost, p.tex);
                grid.appendChild(btn);
            });
        }

        function scrollParts(dir) {
            currentPage = (currentPage + dir + PART_PAGES.length) % PART_PAGES.length;
            renderParts();
        }

        function addPart(name, cost, tex) {
            if (cash < cost) return;
            cash -= cost;
            const container = document.getElementById('rocket-container');
            const el = document.createElement('div');
            el.className = 'placed-part ' + tex;
            el.id = 'part-' + stack.length;
            let hVal = (name.includes('Shield') || name.includes('Decoupler')) ? 30 : 70;
            el.style.height = hVal + 'px';
            el.innerText = name.toUpperCase();
            container.appendChild(el);
            document.getElementById('cash').innerText = cash;
            stack.push({ name, cost, tex, hVal: hVal / 25 });
        }

        function undo() {
            if (stack.length === 0) return;
            const last = stack.pop();
            const el = document.getElementById('part-' + stack.length);
            if(el) el.remove();
            cash += last.cost;
            document.getElementById('cash').innerText = cash;
        }

        function launch() {
            if (stack.length === 0) return;
            document.getElementById('build-screen').style.display = 'none';
            document.getElementById('game-scene').style.display = 'block';
            document.getElementById('return-btn').style.display = 'block';
            
            const v = document.getElementById('visual-stack');
            const group = document.getElementById('rocket-group');
            v.innerHTML = '';
            
            let currentHeight = 0;
            stack.forEach((p) => {
                const e = document.createElement('a-entity');
                let shape = p.name === 'Capsule' ? 'cone' : 'cylinder';
                let h = p.hVal;
                e.setAttribute('geometry', { primitive: shape, radiusBottom: 1.2, radiusTop: (shape==='cone' ? 0 : 1.2), height: h });
                
                let color = "#fff";
                if(p.tex === 'tex-fuel') color = "#ff9900";
                if(p.tex === 'tex-heat') color = "#222";
                if(p.tex === 'tex-tech') color = "#00ffff";
                if(p.tex === 'tex-metal') color = "#555";
                
                e.setAttribute('material', {color: color, metalness: 0.8, roughness: 0.2});
                e.setAttribute('position', `0 ${currentHeight + (h / 2)} 0`);
                currentHeight += h;
                v.appendChild(e);
            });

            setTimeout(() => {
                document.getElementById('fire').setAttribute('visible', 'true');
                group.setAttribute('animation', { property: 'position', to: '0 80 0', dur: 10000, easing: 'easeInQuad' });
            }, 1000);
        }

        function resetBuilder() { location.reload(); }
        window.onload = renderParts;
    </script>
</body>
</html>
